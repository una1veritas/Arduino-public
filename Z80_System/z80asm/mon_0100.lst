                        ; --------------------------------------
                        ; zasm: assemble "mon_0100.asm"
                        ; date: 2025-10-22 01:22:21
                        ; --------------------------------------


                        ; macros
                        clrcf:	macro		; clear carry flag
                        		and 	a
                        		endm
                        ;
                        clra: 	macro
                        		xor 	a
                        		endm
                        ;
                        ; I/O port
                        ;
0000:                   CONSTA 	equ 	0
0001:                   CONIO 	equ 	1
                        ;CONOUT equ 	2
0080:                   CLKMODE	equ 	128
0081:                   LED7SEG	equ 	129
                        ;
                        ;
                        ; a  ... workspace reg.
                        ; b  ... workspace reg. dnjz counter
                        ; c  ... command
                        ; de ... address
                        ;
                        
                        ; rom subroutines;
                        ;
                        
0100:                           org     00100h
0100:                   mon:            ;entry point
0100: 110000   [10]     		ld 		de, 0
0103: ED538003 [30]     		ld 		(OADDR), de
0107: ED538203 [50]     		ld 		(CADDR), de
010B:                   read_line:
010B: 210003   [10]     		ld 		hl, lbuf 	; line buffer
010E: 0E7F     [17]     		ld 		c, BUFSIZE	; line buffer size (except null terminal)
0110: CDCB01   [34]     		call	getln
0113: 210003   [44]     		ld 		hl, lbuf
0116: 7E       [51]     		ld 		a, (hl)
                        ; no arity commands
0117: FE00     [58]     		cp 		$0 		; line is empty
0119: 2846     [65|70]  		jr 		z, default_dump
                        		;
011B: FE48     [72]     		cp 		'H' 	; begins with H
011D: CAC201   [82|82]  		jp 		z, mon_halt
                        		;
0120: FE2E     [89]     		cp 		'.'		; begins with .
0122: 2829     [96|101] 		jr 		z, specify_end
0124: FE3A     [103]    		cp 		':'		; begins with :
0126: 2868     [110|115]		jr 		z, write_mode
0128: FE53     [117]            cp      'S'
                        		;
                        ; specify start address and function
012A: 0E04     [124]    		ld 		c, 4
012C: CDE102   [141]    		call 	hexstr_de
012F: ED538003 [161]    		ld 		(OADDR), de
                        		;
0133: 7E       [168]    		ld 		a, (hl)
0134: FE00     [175]    		cp 		$0
0136: 2829     [182|187]		jr 		z, default_dump
0138: FE2E     [189]    		cp		'.'
013A: 2811     [196|201]		jr 		z, specify_end
013C: FE3A     [203]    		cp		':'
013E: 2850     [210|215]		jr 		z, write_mode
0140: FE52     [217]    		cp		'R'
0142: 2873     [224|229]		jr 		z, run_mode
0144: FE53     [231]    		cp		'S'
0146: 2873     [238|243]		jr 		z, clk_mode
0148: CD5402   [255]    		call 	print_err_msg
014B: 18B3     [267]    		jr 		mon		; OADDR and CADDR are possibly corrupted
                        		;
014D:                   specify_end:
014D: 23       [ 6]     		inc 	hl 		; next to '.'
014E: 0E04     [13]     		ld 		c, 4
0150: CDE102   [30]     		call 	hexstr_de
0153: ED538203 [50]     		ld 		(CADDR), de
0157: 7E       [57]     		ld 		a, (hl)
0158: FE00     [64]     		cp 		0
015A: 2805     [71|76]  		jr 		z, default_dump
015C: CD5402   [88]     		call 	print_err_msg
015F: 189F     [100]    		jr 		mon		; OADDR and CADDR are possibly corrupted
                        		;
0161:                   default_dump:
0161: 2A8003   [16]     		ld 		hl, (OADDR)
0164: ED5B8203 [36]     		ld 		de, (CADDR)
0168: 7C       [40]     		ld 		a, h
0169: BA       [44]     		cp 		d 
016A: 2002     [51|56]  		jr 		nz, $+4 
016C: 7D       [55]     		ld 		a, l 
016D: BB       [59]     		cp 		e 
016E: 3809     [66|71]  		jr 		c, do_dump  ; start < end
0170: 2807     [73|78]  		jr 		z, do_dump  ; start == end
0172: 111000   [83]     		ld 		de, $10
0175: 19       [94]     		add 	hl, de
0176: 228203   [110]    		ld 		(CADDR), hl
                        		;
0179:                   do_dump:
0179: 2A8003   [16]     		ld 		hl, (OADDR)
017C: ED5B8203 [36]     		ld 		de, (CADDR)
0180: CD7A02   [53]     		call 	dump
0183: 228003   [69]     		ld 		(OADDR), hl
0186: 110000   [79]     		ld 		de, 0
0189: ED538203 [99]     		ld 		(CADDR), de
018D: C30B01   [109]    		jp 		read_line
                                ;
0190:                   write_mode:
0190: 23       [ 6]     		inc 	hl 		; next to ':'
0191: 7E       [13]     		ld 		a, (hl)
0192: FE20     [20]     		cp 		' '
0194: 28FA     [27|32]  		jr 		z, write_mode
                        		;
0196: 0E02     [34]     		ld 		c, 2
0198: CDE102   [51]     		call 	hexstr_de
019B: 79       [55]     		ld 		a, c 
019C: FE02     [62]     		cp 		a, 2
019E: 2814     [69|74]  		jr 		z, write_mode.exit	; no arg or illegal char
01A0: DD2A8003 [89]     		ld 		ix, (OADDR)
01A4: DD7300   [108]    		ld 		(ix), e
01A7: DD23     [118]    		inc 	ix
01A9: DD228003 [138]    		ld 		(OADDR), ix
01AD: 7E       [145]    		ld 		a, (hl)
01AE: FE00     [152]    		cp 		0
01B0: 2802     [159|164]		jr 		z, write_mode.exit
01B2: 18DC     [171]    		jr 		write_mode
01B4:                   write_mode.exit
01B4: C30B01   [10]     		jp 		read_line
                        ;
01B7:                   run_mode:
01B7: 2A8003   [16]     		ld 		hl, (OADDR)
01BA: E9       [20]     		jp 		(hl)
                        ;;
                        ;  clockspeed change by output number to port 128
01BB:                   clk_mode:
01BB: 7B       [ 4]     		ld 		a, e
01BC: CDF802   [21]     		call 	clk_spd_change
01BF: C30B01   [31]     		jp 		read_line
                        ;
01C2:                   mon_halt:
01C2: 76       [ 4]     		halt
                        
                        
                        ; subroutines
                        ; getchar
01C3:                   getchar:
01C3: DB00     [11]     		in 		a, (CONSTA)
01C5: A7       [15]     		and 	a
01C6: 28FB     [22|27]  		jr 		z, getchar
01C8: DB01     [33]     		in 		a, (CONIO)
01CA: C9       [43]     		ret
                        
                        ; getlin
                        ; read up to c bytes into buffer pointed by hl, end with 0
                        ; hl ... line buffer pointer
                        ; c  .... buffer limit length
01CB:                   getln:
01CB: 3600     [10]     		ld 		(hl), 0
01CD: 0600     [17]     		ld 		b, 0		; char count
01CF: CD4302   [34]     		call 	print_endl
01D2: 3E2A     [41]     		ld 		a, '*'
01D4: D301     [52]     		out 	(CONIO), a
                                ;
01D6:                   getln_wait:
01D6: CDC301   [17]     		call 	getchar
                        		;in 		a, (CONSTA)
                        		;and 	a
                        		;jr 		z, getln_wait
                        		;in 		a, (CONIO)
                        		; 
01D9: FE08     [24]     		cp 		$08 	;backspace
01DB: 2816     [31|36]  		jr 		z, getln_bkspc
01DD: FE7F     [38]     		cp 		$7f		; del
01DF: 2812     [45|50]  		jr 		z, getln_bkspc
01E1: FE1B     [52]     		cp 		$1b
01E3: 2824     [59|64]  		jr 		z, getln_escseq
01E5: FE0A     [66]     		cp 		$0a
01E7: 283D     [73|78]  		jr 		z, getln_end
01E9: FE0D     [80]     		cp 		$0d
01EB: 2839     [87|92]  		jr 		z, getln_end
                        ; other ctrl codes
01ED: FE20     [94]     		cp 		$20
01EF: 3028     [101|106]		jr 		nc, getln_echo_proceed
01F1: 18E3     [113]    		jr 		getln_wait
                        
01F3:                   getln_bkspc:
01F3: 78       [ 4]     		ld 		a, b
01F4: A7       [ 8]     		and 	a
01F5: 28DF     [15|20]  		jr 		z, getln_wait
01F7: 3E08     [22]     		ld 		a, $08
01F9: D301     [33]     		out 	(CONIO), a
01FB: 3E20     [40]     		ld 		a, ' '
01FD: D301     [51]     		out 	(CONIO), a
01FF: 3E08     [58]     		ld 		a, $08
0201: D301     [69]     		out 	(CONIO), a
0203: 2B       [75]     		dec 	hl
0204: 3600     [85]     		ld 		(hl), $0
0206: 05       [89]     		dec 	b
0207: 18CD     [101]    		jr 		getln_wait
                        
0209:                   getln_escseq:
0209: CDC301   [17]     		call  	getchar
020C: FE5B     [24]     		cp 		'['
020E: 20C6     [31|36]  		jr 		nz, getln_wait
0210: CDC301   [48]     		call 	getchar
0213: FE44     [55]     		cp 		'D'
0215: 28DC     [62|67]  		jr 		z, getln_bkspc
0217: 18BD     [74]     		jr 		getln_wait
                        
0219:                   getln_echo_proceed:
0219: D301     [11]     		out 	(CONIO), a 		; echo back
                        		;
021B: 77       [18]     		ld 		(hl),a		; *ptr++ = a
021C: 23       [24]     		inc 	hl
021D: 3600     [34]     		ld 		(hl), $0	; *ptr = NULL
021F: 04       [38]     		inc 	b
0220: 78       [42]     		ld 		a, b
0221: B9       [46]     		cp 		c
0222: 3002     [53|58]  		jr 		nc, getln_end  ; force terminate line
0224: 18B0     [65]     		jr 		getln_wait
                        
0226:                   getln_end:	; parse lbuf
0226: C9       [10]     		ret
                        
                        ;
                        ; print a nibble in A
0227:                   print_nibble:
0227: E60F     [ 7]     		and 	$0f
0229: FE0A     [14]     		cp 		$a
022B: C630     [21]     		add 	'0'
022D: FE3A     [28]     		cp 		':'
022F: 3802     [35|40]  		jr 		c, print_nibble_out
0231: C607     [42]     		add 	7
0233:                   print_nibble_out:
0233: D301     [11]     		out 	(CONIO), a
0235: C9       [21]     		ret
                        
                        ; print a byte in A
0236:                   print_byte:
0236: F5       [11]     		push 	af
0237: 07       [15]     		rlca
0238: 07       [19]     		rlca
0239: 07       [23]     		rlca
023A: 07       [27]     		rlca
023B: CD2702   [44]     		call 	print_nibble
023E: F1       [54]     		pop 	af
023F: CD2702   [71]     		call 	print_nibble
0242: C9       [81]     		ret
                        
0243:                   print_endl:
0243: 3E0A     [ 7]     		ld 		a, $0a
0245: D301     [18]     		out 	(CONIO), A
0247: 3E0D     [25]     		ld 		a, $0d
0249: D301     [36]     		out 	(CONIO), A
024B: C9       [46]     		ret
                        ;
024C:                   print_str_hl:
024C: 7E       [ 7]     		ld 		a,(hl)
024D: A7       [11]     		and 	A
024E: C8       [16|22]  		ret 	z
024F: D301     [27]     		out 	(CONIO), a
0251: 23       [33]     		inc 	hl
0252: 18F8     [45]     		jr 		print_str_hl
                        ;
                        ;
0254:                   print_err_msg:
0254: E5       [11]     		push 	hl
0255: F5       [22]     		push 	af
0256: CD4302   [39]     		call 	print_endl
0259: 217002   [49]     		ld 		hl, str_err
025C: CD4C02   [66]     		call 	print_str_hl
025F: F1       [76]     		pop 	af
0260: CD3602   [93]     		call 	print_byte
0263: CD4302   [110]    		call 	print_endl
0266: E1       [120]    		pop 	hl
0267: 7C       [124]    		ld 		a, h
0268: CD3602   [141]    		call 	print_byte
026B: 7D       [145]    		ld 		a, l
026C: CD3602   [162]    		call 	print_byte
026F: C9       [172]    		ret
                        		;
0270:                   str_err:
0270: 0A0D6572          		db 	$0a, $0d, "error"
0274: 726F72            
0277:                   str_endl:
0277: 0A0D00            		db $0a, $0d, 0
                        ;
                        
                        ; dump : dump memory from OADDR to OADDR+2 (value)
                        ; hl ... start address (will be trucated)
                        ; de ... end address
                        ;
                        ; bc ... the original start address
                        
027A:                   dump:
027A: 44       [ 4]     	ld 		b, h
027B: 4D       [ 8]     	ld 		c, l
027C: 3EF0     [15]     	ld 		a, $F0
027E: A5       [19]     	and 	l
027F: 6F       [23]     	ld 		l, a
0280:                   dump.print_header:
0280: CD4302   [17]     	call 	print_endl
0283: 78       [21]     	ld 		a, b
0284: CD3602   [38]     	call 	print_byte
0287: 79       [42]     	ld 		a, c
0288: CD3602   [59]     	call 	print_byte
028B: 3E20     [66]     	ld 		a, ' '
028D: D301     [77]     	out 	(CONIO), a
028F: 3E3A     [84]     	ld 		a, ':'
0291: D301     [95]     	out 	(CONIO), a
0293: 3E20     [102]    	ld 		a, ' '
0295: D301     [113]    	out 	(CONIO), a
                            ;
0297:                   dump.bytes:
                        	;cp 	bc, hl
0297: 78       [ 4]     	ld 		a, b
0298: BC       [ 8]     	cp 		h
0299: 2002     [15|20]  	jr 		nz, $+4
029B: 79       [19]     	ld 		a, c
029C: BD       [23]     	cp 		l
                        	;
029D: 380A     [30|35]  	jr 		c, dump.print_byte
029F: 2808     [37|42]  	jr 		z, dump.print_byte
                        ; print two-spaces
02A1: 3E20     [44]     	ld 		a, ' '
02A3: D301     [55]     	out 	(CONIO), a
02A5: D301     [66]     	out 	(CONIO), a
02A7: 1804     [78]     	jr 		dump.print_spc
02A9:                   dump.print_byte
02A9: 7E       [ 7]     	ld 		a, (hl)
02AA: CD3602   [24]     	call 	print_byte
02AD:                   dump.print_spc:
02AD: 3E20     [ 7]     	ld 		a, ' '
02AF: D301     [18]     	out 	(CONIO), a
02B1: 23       [24]     	inc 	hl
                        	; cp 	de, hl
02B2: 7A       [28]     	ld 		a, d
02B3: BC       [32]     	cp 		h
02B4: 2002     [39|44]  	jr 		nz, $+4; dump.cp_de_hl_end
02B6: 7B       [43]     	ld 		a, e
02B7: BD       [47]     	cp 		l
                        	; cp 	de, hl end
02B8: C8       [52|58]  	ret 	z ; de == hl, then exit dump
02B9: D8       [57|63]  	ret 	c ; de < hl, then exit dump
02BA: 7D       [61]     	ld 		a, l 	; test whether the least 4 bits of address is zero
02BB: E60F     [68]     	and 	$0f
02BD: 20D8     [75|80]  	jr 		nz, dump.bytes
02BF: 44       [79]     	ld 		b, h 
02C0: 4D       [83]     	ld 		c, l
02C1: 18BD     [95]     	jr 		dump.print_header  ; if so print address header
                            ;
                        
                        ; convert one char expressing a hexadecimal digit 
                        ; in A reg. to nibble in A
                        ; set carry flag if got a wrong char
                        ;
02C3:                   hex2nib:
02C3: FE30     [ 7]     		cp 		'0'
02C5: D8       [12|18]  		ret 	c		; A < '0'
02C6: FE3A     [19]     		cp 		'9' + 1
02C8: 3003     [26|31]  		jr 		nc, hex2nib.alpha
02CA: D630     [33]     		sub 	'0' 	; A was digit, results carry reset
02CC: C9       [43]     		ret
02CD:                   hex2nib.alpha:
02CD: FE61     [ 7]     		cp 		'a'
02CF: 3806     [14|19]  		jr 		c, hex2nib.upper
02D1: FE67     [21]     		cp 		'f'+1
02D3: 3F       [25]     		ccf		; set carry if A >= 'f'+1
02D4: D8       [30|36]  		ret 	c
02D5: E6DF     [37]     		and 	$df		; a - f to upper char
02D7:                   hex2nib.upper:
02D7: FE41     [ 7]     		cp 		'A'
02D9: D8       [12|18]  		ret 	c
02DA: FE47     [19]     		cp      'F' + 1
02DC: 3F       [23]     		ccf
02DD: D8       [28|34]  		ret 	c      ; error if it is larger than 'F'
02DE: D637     [35]     		sub 	'A'-10
02E0: C9       [45]     		ret
                        
                        ; read hexadecimal string char upto 2 or 4 (set in C) 
                        ; bytes from (HL) and return int val in DE
                        ; if non hexdec char is encountered at (HL), returns with current de value without inc hl.
                        ; if C upper-limit bytes has been read, returns with current de value with increment hl.
                        ; A reg. hold the last char read from (HL).
                        ;
02E1:                   hexstr_de:
02E1: 110000   [10]     		ld      de, 0000h
02E4:                   hexstr_de.loop:
02E4: 7E       [ 7]     		ld      a, (hl)
02E5: CDC302   [24]     		call 	hex2nib
02E8: D8       [29|35]  		ret 	c 			; encountered non-hexdec char.
02E9:                   hexstr_de.hex2nib_succ:
02E9: 0604     [ 7]     		ld 		b, 4
02EB:                   hexstr_de.rl4:
02EB: CB13     [ 8]     		rl      e		 ;rotate left entire de
02ED: CB12     [16]     		rl      d
02EF: 10FA     [24|29]  		djnz    hexstr_de.rl4
02F1: 83       [28]     		add 	e
02F2: 5F       [32]     		ld 		e, a
02F3: 23       [38]     		inc 	hl 		; 
02F4: 0D       [42]     		dec 	c
02F5: 20ED     [49|54]  		jr      nz, hexstr_de.loop
02F7: C9       [59]     		ret 			; return after c bytes read
                        
                        ;
02F8:                   clk_spd_change:
02F8: E607     [ 7]     		and 	$07
02FA: D380     [18]     		out		(CLKMODE), a
02FC: C9       [28]     		ret
                        ;
                        ; work space
                        			org 	0300h
0300:                   workspace:
0300: FFFFFFFF          lbuf: 		ds 		128
0304: FF...             
007F:                   BUFSIZE 	EQU 	127
0380: 0000              OADDR:		DB		0, 0
0382: 0000              CADDR:		DB		0, 0
0384: 00                STATE: 		DB 		0
                        ;


; +++ segments +++

#CODE          = $0100 =   256,  size = $0285 =   645

; +++ global symbols +++

BUFSIZE           = $007F =   127          mon_0100.asm:411
CADDR             = $0382 =   898          mon_0100.asm:413
CLKMODE           = $0080 =   128          mon_0100.asm:15
CONIO             = $0001 =     1          mon_0100.asm:13
CONSTA            = $0000 =     0          mon_0100.asm:12
LED7SEG           = $0081 =   129          mon_0100.asm:16 (unused)
OADDR             = $0380 =   896          mon_0100.asm:412
STATE             = $0384 =   900          mon_0100.asm:414 (unused)
_end              = $0385 =   901          mon_0100.asm:28 (unused)
_size             = $0285 =   645          mon_0100.asm:28 (unused)
clk_mode          = $01BB =   443          mon_0100.asm:132
clk_spd_change    = $02F8 =   760          mon_0100.asm:402
default_dump      = $0161 =   353          mon_0100.asm:82
do_dump           = $0179 =   377          mon_0100.asm:96
dump              = $027A =   634          mon_0100.asm:291
dump.bytes        = $0297 =   663          mon_0100.asm:310
dump.print_byte   = $02A9 =   681          mon_0100.asm:325
dump.print_header = $0280 =   640          mon_0100.asm:297
dump.print_spc    = $02AD =   685          mon_0100.asm:328
getchar           = $01C3 =   451          mon_0100.asm:143
getln             = $01CB =   459          mon_0100.asm:154
getln_bkspc       = $01F3 =   499          mon_0100.asm:183
getln_echo_proceed = $0219 =   537          mon_0100.asm:207
getln_end         = $0226 =   550          mon_0100.asm:219
getln_escseq      = $0209 =   521          mon_0100.asm:198
getln_wait        = $01D6 =   470          mon_0100.asm:161
hex2nib           = $02C3 =   707          mon_0100.asm:353
hex2nib.alpha     = $02CD =   717          mon_0100.asm:360
hex2nib.upper     = $02D7 =   727          mon_0100.asm:367
hexstr_de         = $02E1 =   737          mon_0100.asm:382
hexstr_de.hex2nib_succ = $02E9 =   745          mon_0100.asm:388 (unused)
hexstr_de.loop    = $02E4 =   740          mon_0100.asm:384
hexstr_de.rl4     = $02EB =   747          mon_0100.asm:390
lbuf              = $0300 =   768          mon_0100.asm:410
mon               = $0100 =   256          mon_0100.asm:29
mon_halt          = $01C2 =   450          mon_0100.asm:137
print_byte        = $0236 =   566          mon_0100.asm:236
print_endl        = $0243 =   579          mon_0100.asm:247
print_err_msg     = $0254 =   596          mon_0100.asm:263
print_nibble      = $0227 =   551          mon_0100.asm:224
print_nibble_out  = $0233 =   563          mon_0100.asm:231
print_str_hl      = $024C =   588          mon_0100.asm:254
read_line         = $010B =   267          mon_0100.asm:33
run_mode          = $01B7 =   439          mon_0100.asm:127
specify_end       = $014D =   333          mon_0100.asm:71
str_endl          = $0277 =   631          mon_0100.asm:281 (unused)
str_err           = $0270 =   624          mon_0100.asm:279
workspace         = $0300 =   768          mon_0100.asm:409 (unused)
write_mode        = $0190 =   400          mon_0100.asm:105
write_mode.exit   = $01B4 =   436          mon_0100.asm:124


total time: 0.0021 sec.
no errors
